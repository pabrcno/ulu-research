flowchart TD
    User(["ðŸ‘¤ User"])

    subgraph INPUT["INPUT LAYER"]
        A["Search Query\ne.g. 'wireless earbuds'"]
        B["User Country Detection\nIP Geolocation / Manual\nâ†’ drives geo= on all calls"]
    end

    subgraph LLM_EXTRACT["ðŸ§  LLM KEYWORD EXTRACTION â€” Claude"]
        C["Extract Product Metadata\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Product Category\nâ€¢ HS Tariff Code\nâ€¢ Regulatory Flags  FCC Â· CE Â· RoHS\nâ€¢ Market Search Terms\nâ€¢ Trend Keywords  1â€“5 terms\nâ€¢ Normalized Search String"]
    end

    subgraph PARALLEL["PARALLEL EXECUTION  â€”  single SERPAPI_API_KEY"]
        direction LR

        subgraph SOURCING["ðŸ’° MULTI-PLATFORM SOURCING  â€”  SerpApi"]
            direction TB

            P1["engine=alibaba\nkeywords Â· page_size\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nWholesale Â· MOQ pricing\nManufacturer suppliers\nBulk unit costs"]

            P2["engine=amazon\nkeywords Â· amazon_domain\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nRetail reference prices\nBrand landscape\nReview volume signals"]

            P3["engine=ebay\nkeywords Â· ebay_domain\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nSecondary market prices\nLot / bulk listings\nCondition variants"]

            P4["engine=walmart\nkeywords\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nMass retail pricing\nUS market baseline\nPrivate label signals"]

            P5["engine=google_shopping\nq Â· location Â· gl\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nCross-platform price index\nLocal availability\nSponsor vs organic"]

            PRICE_LLM["ðŸ§  Price Synthesis â€” Claude\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Wholesale floor price  Alibaba\nâ€¢ Retail ceiling price  Amazon Â· Walmart\nâ€¢ Gross margin range %\nâ€¢ Price position per platform\nâ€¢ Arbitrage signals"]

            P1 & P2 & P3 & P4 & P5 --> PRICE_LLM
        end

        subgraph TRENDS_COL["ðŸ“ˆ TRENDS â€” SerpApi"]
            direction TB

            T1["engine=google_trends\ndata_type=TIMESERIES\ngeo=USER_COUNTRY\ndate=today 12-m\nâ†’ interest_over_time  0â€“100"]
            T2["data_type=GEO_MAP\nâ†’ regional hotspots"]
            T3["data_type=RELATED_QUERIES\nâ†’ rising Â· top queries"]
            T4["data_type=RELATED_TOPICS\nâ†’ rising Â· top topics"]

            TREND_LLM["ðŸ§  Trend Synthesis â€” Claude\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Direction  â†‘ â†— â†’ â†˜ â†“\nâ€¢ Seasonality + peak month\nâ€¢ Breakout rising queries\nâ€¢ Regional demand hotspots\nâ€¢ Trend score  0â€“100"]

            T1 --> T2 --> T3 --> T4 --> TREND_LLM
        end

        subgraph REGULATION["ðŸŒ IMPORT REGULATIONS â€” Tavily"]
            direction TB
            R1["Targeted queries built from\nHS code Â· regulatory_flags[]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Tariff + duty rate\nâ€¢ Required certifications\nâ€¢ Prohibited variants\nâ€¢ Labeling requirements\nâ€¢ Licensing + quotas"]
            R2["ðŸ§  Regulation Synthesis â€” Claude\nStructured card + citations\nfrom official .gov domains"]
            R1 --> R2
        end

        subgraph MARKET["ðŸ“Š MARKET RESEARCH â€” Tavily"]
            direction TB
            M1["Targeted queries from\nmarket_terms[] + country\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Local competitors\nâ€¢ Demand landscape\nâ€¢ Best sales channels\nâ€¢ Consumer sentiment"]
            M2["ðŸ§  Market Synthesis â€” Claude\nCompetition level Â· channels\npositioning Â· summary"]
            M1 --> M2
        end
    end

    subgraph FUSION["ðŸ”€ OPPORTUNITY FUSION â€” Claude"]
        F["Cross-signal synthesis\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nPlatform prices + Trends + Market + Regulations\nâ†’ Opportunity Score  0â€“100\nâ†’ Best wholesale platform to source from\nâ†’ Estimated margin %  wholesale â†’ retail\nâ†’ Best launch month\nâ†’ Keyword + variant gaps\nâ†’ Risk flags  margin squeeze Â· declining trend Â· compliance blocker"]
    end

    subgraph OUTPUT["ðŸ“‹ RESEARCH DASHBOARD"]
        O1["ðŸ’° Sourcing Panel\nPrice comparison across platforms\nAlibaba wholesale floor Â· Amazon Â· eBay Â· Walmart retail ceiling\nMargin range Â· Best source"]
        O2["ðŸ“ˆ Trends Panel\nTimeseries chart Â· Regional heatmap\nRising queries Â· Trend score"]
        O3["ðŸŒ Regulation Card\nDuty rate Â· Certifications\nRestrictions Â· Gov source citations"]
        O4["ðŸ“Š Market Report\nCompetitor landscape Â· Channels\nPositioning Â· Summary"]
        O5["ðŸŽ¯ Opportunity Report\nScore Â· Margin estimate\nBest platform Â· Launch timing\nRisk flags Â· Variant suggestions"]
    end

    User --> A & B
    A & B --> C

    C -->|"normalized search string"| P1 & P2 & P3 & P4 & P5
    C -->|"trend keywords Â· geo"| T1
    C -->|"hs_code Â· flags Â· country"| R1
    C -->|"market terms Â· country"| M1

    PRICE_LLM --> O1
    PRICE_LLM --> F
    TREND_LLM --> O2
    TREND_LLM --> F
    R2 --> O3
    R2 --> F
    M2 --> O4
    M2 --> F

    F --> O5

    O1 & O2 & O3 & O4 & O5 --> User

    style INPUT fill:#1e293b,stroke:#334155,color:#e2e8f0
    style LLM_EXTRACT fill:#312e81,stroke:#4338ca,color:#e0e7ff
    style PARALLEL fill:#0a0f1e,stroke:#1e293b,color:#e2e8f0
    style SOURCING fill:#064e3b,stroke:#059669,color:#d1fae5
    style TRENDS_COL fill:#134e4a,stroke:#0d9488,color:#ccfbf1
    style REGULATION fill:#7c2d12,stroke:#ea580c,color:#ffedd5
    style MARKET fill:#1e3a5f,stroke:#3b82f6,color:#dbeafe
    style FUSION fill:#3b0764,stroke:#a855f7,color:#f3e8ff
    style OUTPUT fill:#1f2937,stroke:#374151,color:#f9fafb
    style User fill:#0f172a,stroke:#6366f1,color:#e0e7ff
